{% extends "base.html" %}

{% block title %}Document Management{% endblock %}

{% block content %}
<h1 class="text-center">Document Management</h1>
<form id="documentForm" class="mt-4">
    <div class="mb-3">
        <label for="documentType" class="form-label">Document Type</label>
        <select id="documentType" class="form-control" required>
            <option value="">Select Document Type</option>
            <option value="CC">CC</option>
            <option value="TI">TI</option>
            <option value="CE">CE</option>
            <option value="PT">PT</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="documentContent" class="form-label">Document Content</label>
        <textarea id="documentContent" class="form-control" placeholder="Enter the content of the document" required></textarea>
    </div>
    <div class="mb-3">
        <label for="Envio" class="form-label">Delivery Method</label>
        <select id="Envio" class="form-control" required>
            <option value="1">Email</option>
        </select>
    </div>
    <button type="submit" class="btn btn-success">Submit</button>
</form>
<div id="response" class="mt-3"></div>
<script>
    document.getElementById('documentForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        const documentType = document.getElementById('documentType').value.trim();
        const documentContent = document.getElementById('documentContent').value.trim();
        const envio = document.getElementById('Envio').value;

        // Validación en el frontend
        if (!documentType || !documentContent || !envio) {
            document.getElementById('response').innerHTML = `<div class="alert alert-danger">All fields are required.</div>`;
            return;
        }

        try {
            const response = await fetch('/api/documents', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    document_data: {
                        document_type: documentType,
                        content: documentContent,
                        envio: parseInt(envio, 10)
                    }
                })
            });

            const result = await response.json();

            if (response.ok) {
                document.getElementById('response').innerHTML = `
                    <div class="alert alert-success">
                        <strong>Success:</strong> ${result.message}
                    </div>`;
            } else {
                document.getElementById('response').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${result.error || result.message}
                    </div>`;
            }
        } catch (error) {
            document.getElementById('response').innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error:</strong> An error occurred while processing your request.
                </div>`;
            console.error(error);
        }
    });
</script>
{% endblock %}

from flask import Blueprint, request, jsonify

documentos_bp = Blueprint('documents', __name__)

VALID_ENVIO = [1]  # Solo se permite "Email"

@documentos_bp.route('/documents', methods=['POST'])
def manage_documents():
    data = request.json
    if not data or 'document_data' not in data:
        return jsonify({"error": "The 'document_data' field is required"}), 400

    document_data = data['document_data']

    # Validar campos requeridos
    if 'document_type' not in document_data or 'content' not in document_data or 'envio' not in document_data:
        return jsonify({"error": "All fields ('document_type', 'content', 'envio') are required"}), 400

    # Validar medio de envío
    if document_data['envio'] not in VALID_ENVIO:
        return jsonify({"error": "Invalid 'envio'. Only 'Email' is allowed"}), 400

    # Simulación de éxito
    return jsonify({"status": "success", "message": "Document managed successfully", "document_data": document_data})